# 데이터 자동 정제 기술 제안 (RAG/LoRA용)

본 문서는 2022 교육과정, 교사용 지도서, 지도안 예시를 대량 처리하기 위한 **자동 정제 파이프라인** 기술을 제안합니다. 모든 단계는 재현 가능하도록 로그·메타데이터를 남기며, 실패한 문서는 별도 큐로 분류하여 재처리합니다.¹

## 1. 소스별 전처리 모듈

| 소스 | 입력 형태 | 제안 기술 | 정제 결과 |
| --- | --- | --- | --- |
| 2022 교육과정 | PDF·HWP | `pdfplumber`/`pypdf` + `pyhwp` 추출, 폰트·레이아웃 보정 | 계층 구조가 유지된 Markdown (목차 > 성취기준 > 해설) |
| 교사용 지도서 | 스캔 PDF·이미지 | OCR(Tesseract, easyOCR) + 레이아웃 분석(LayoutLMv3/Kosbi) | 본문·표·수식 분리 텍스트 + 위치 메타데이터 |
| 지도안 예시 | HWP·DOCX·PDF | `python-docx`, `pyhwp`, `pdfplumber` | 템플릿 필드별 JSON (도입/전개/정리/평가) |

## 2. 자동 정제 파이프라인 설계

1. **수집(Ingest):** 소스 경로, 저작권, 버전 메타데이터를 수집 큐에 기록합니다.²
2. **텍스트 추출:** 입력 포맷 감지 후 적합한 추출기 모듈을 호출하고, 페이지 단위로 저장합니다.
3. **정규화:**
   - 공백·줄바꿈 정돈, 스마트 따옴표·불용문자 제거, Unicode NFC 정규화.
   - HWP 수식은 LaTeX으로 치환, 이미지 수식은 MathPix API 등으로 변환.
4. **구조 복원:**
   - 목차 기반 섹션 트리 재구성(heading depth 제한), 표는 Markdown/CSV, 리스트는 순서 유지.
   - 지도안 예시는 `도입/전개/정리/형성평가/과제` 필드로 파싱.
5. **품질 필터링:**
   - **OCR 신뢰도**(90% 미만), **문서 길이**(토큰 수), **비한글 비중** 등을 점검해 재처리 큐로 보냅니다.
   - 레이아웃 인식 실패 시 이미지 분할 후 재-OCR.
6. **개인정보 탐지/마스킹:**
   - 정규식 + 한국어 NER(KLUE/BERT)로 이름·전화·이메일·주소 탐지, `[[PII]]`로 마스킹.
   - 로그에 탐지 위치와 규칙 ID를 저장해 감사 가능성 확보.
7. **중복·저작권 체크:**
   - 해시(SimHash)로 중복 여부 판단, 동일 저작권·버전 메타데이터 묶음끼리만 중복 제거.
   - 라이선스·출처를 필드로 강제 저장하고, 미확인 문서는 격리 큐에 둡니다.
8. **LLM 보조 후처리:**
   - 소단위 청크(세부 성취기준, 수업 단계)마다 스타일 정규화 프롬프트 적용.
   - 문장 단위 품질 기준(길이·명사구 비율 등)을 속성으로 함께 기록합니다.
9. **출력 포맷:**
   - **벡터화용**: 청크 텍스트 + 메타데이터(JSONL). 청크 키: `source`, `grade`, `unit`, `subunit`, `lesson`, `copyright`, `pii_masked`.
   - **LoRA 학습용**: 템플릿 필드가 분리된 JSONL, 라벨(`도입/전개/정리/평가`) 포함.

## 3. 자동화 파이프라인 기술 스택

- **워크플로 엔진:** Apache Airflow / Prefect (재시도, 의존성, SLA 관리)
- **문서 처리:** pdfplumber, pypdf, pyhwp, python-docx, unstructured.io
- **OCR·레이아웃:** Tesseract + Korean tessdata, easyOCR, LayoutLMv3/DocLayout-YOLO, PaddleOCR의 KIE 모듈
- **수식 처리:** MathPix API 또는 Nougat(수식 인식), LaTeXLint로 정합성 점검
- **언어 정규화:** KoNLPy/SoMaJo for Korean tokenization, pykospacing·kr-normalizer
- **PII 탐지:** 정규식 + KoELECTRA/klue-ner 파인튜닝 모델
- **품질 검증:** spaCy/Khaiii 기반 언어 통계, SimHash/MinHash 중복 검출, langdetect로 언어 비율 확인
- **관찰성:** OpenTelemetry 로깅, Prometheus 메트릭, 실패 청크를 위한 Dead-Letter Queue(Redis/Kafka)

## 4. 운영 가이드

- **버전 관리:** 원본·정제본 해시, 처리 파이프라인 버전, 모델 버전을 함께 기록하여 회귀 분석에 활용합니다.
- **샘플링 점검:** 파이프라인별 1% 샘플을 주간 리뷰해 OCR·PII·구조 복원 품질을 평가합니다.
- **성능 목표:** 문서 1건당 1분 내 처리, OCR 신뢰도 95% 이상, PII 탐지 재현율 0.9 이상을 초기 기준으로 설정합니다.
- **보안:** PII가 포함된 중간 산출물은 암호화 스토리지에만 저장하고, 접근 로그를 남깁니다.

## 5. 향후 확장 아이디어

- **문서 분류기 자동 선택:** 전처리 전에 문서 타입 분류 CNN/Transformer를 넣어 최적 추출기를 자동 매칭.
- **LLM 기반 구조 태깅:** 지도안 내 활동/자료/평가 항목을 시퀀스 태깅으로 자동 분리하여 LoRA 학습 데이터 품질 향상.
- **자동 회수 루프:** 사용자 피드백이 낮은 지도안 청크를 역추적하여 OCR/파싱 단계 재실행, 메타데이터 업데이트.
- **저작권 워터마크 탐지:** PDF 워터마크/메타데이터 스캔 후 위험 문서는 격리 처리.

---

¹ "재현 가능"은 동일 입력과 파이프라인 버전으로 동일 결과를 얻을 수 있음을 의미합니다. 모든 중간 산출물 해시를 기록해 디버깅을 돕습니다.  
² 메타데이터 예: `source=교사용 지도서`, `copyright=ⓒ교육부`, `year=2022`, `publisher=OO출판`, `license=교육용`, `version=1.0`.
